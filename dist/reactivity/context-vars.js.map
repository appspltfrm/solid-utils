{"version":3,"file":"context-vars.js","sources":["../../src/lib/reactivity/context-vars.ts"],"sourcesContent":["import {getOwner, onCleanup, Owner} from \"solid-js\";\n\ntype Vars = {[key: string | symbol]: any};\ntype VarName = string | symbol;\n\nconst allVars = new WeakMap<Owner, Vars>()\n\nclass VarValue {\n    value: any;\n    onDelete?: () => void;\n}\n\nfunction assertNotExists(vars: Vars | undefined, name: VarName) {\n    if (vars && name in vars) {\n        throw new Error(`Var ${String(name)} already exists`);\n    }\n}\n\nfunction assertExists(vars: Vars | undefined, name: VarName) {\n    if (vars && !(name in vars)) {\n        throw new Error(`Var ${String(name)} not exists`);\n    }\n}\n\nexport function createContextVar<T>(name: string | symbol, initialValue: T): T;\n\nexport function createContextVar<T>(name: string | symbol, initialValue?: T) {\n    const owner = getOwner();\n\n    if (!owner) {\n        throw new Error(\"No owner, cannot create context\");\n    }\n\n    let vars = allVars.get(owner);\n    assertNotExists(vars, name);\n\n    if (!vars) {\n        allVars.set(owner, vars = {});\n\n        onCleanup(() => allVars.delete(owner));\n    }\n\n    vars[name] = initialValue;\n\n    return initialValue;\n}\n\nexport function getContextVar<T>(name: string | symbol): T | undefined {\n\n    let owner = getOwner();\n    if (!owner) {\n        throw new Error(\"No owner, cannot create context\");\n    }\n\n    while (owner) {\n\n        const vars = allVars.get(owner);\n        if (vars) {\n            if (name in vars) {\n                return vars[name];\n            }\n        }\n\n        owner = owner.owner;\n    }\n}\n"],"names":["allVars","assertNotExists","vars","name","createContextVar","initialValue","owner","getOwner","onCleanup","getContextVar"],"mappings":";AAKA,MAAMA,wBAAc;AAOpB,SAASC,EAAgBC,GAAwBC,GAAe;AACxD,MAAAD,KAAQC,KAAQD;AAChB,UAAM,IAAI,MAAM,OAAO,OAAOC,CAAI,kBAAkB;AAE5D;AAUgB,SAAAC,EAAoBD,GAAuBE,GAAkB;AACzE,QAAMC,IAAQC;AAEd,MAAI,CAACD;AACK,UAAA,IAAI,MAAM,iCAAiC;AAGjD,MAAAJ,IAAOF,EAAQ,IAAIM,CAAK;AAC5B,SAAAL,EAAgBC,GAAMC,CAAI,GAErBD,MACDF,EAAQ,IAAIM,GAAOJ,IAAO,CAAE,CAAA,GAE5BM,EAAU,MAAMR,EAAQ,OAAOM,CAAK,CAAC,IAGzCJ,EAAKC,CAAI,IAAIE,GAENA;AACX;AAEO,SAASI,EAAiBN,GAAsC;AAEnE,MAAIG,IAAQC;AACZ,MAAI,CAACD;AACK,UAAA,IAAI,MAAM,iCAAiC;AAGrD,SAAOA,KAAO;AAEJ,UAAAJ,IAAOF,EAAQ,IAAIM,CAAK;AAC9B,QAAIJ,KACIC,KAAQD;AACR,aAAOA,EAAKC,CAAI;AAIxB,IAAAG,IAAQA,EAAM;AAAA,EAClB;AACJ;"}